# Inf-Net: Automatic COVID-19 Lung Infection Segmentation from CT Images

Used to generate chest X-ray training data for segmentation of COVID-19 lung lesions on annotated X-rays as outlined in [this repository](https://github.com/rvignav/CT2Xray).

## 1. Introduction

<p align="center">
    <img src="http://dpfan.net/wp-content/uploads/COVID19-Infection-1.png"/> <br />
    <em> 
    Figure 1. Example of COVID-19 infected regions in CT axial slice, where the red and green masks denote the 
    ground-glass opacity (GGO) and consolidation, respectively. The images are collected from [1].
    </em>
</p>

> [1] COVID-19 CT Segmentation Dataset, https://medicalsegmentation.com/covid19/, accessed: 2020-04-11.

## 2. Inf-Net

- **Requisite Downloads:**

    You can download the `Dataset` folder [here](https://github.com/rvignav/Inf-Net/blob/master/Dataset/DOWNLOAD.md).
    
    You can download the `Snapshots` folder [here](https://github.com/rvignav/Inf-Net/blob/master/Snapshots/DOWNLOAD.md).

- **Environment Configuration:**

    Note that Inf-Net series is only tested on Ubuntu OS 16.04 with the following environments (CUDA-10.0). 
    It may work on other operating systems as well but we do not guarantee that it will.
    
    + Creating a virtual environment in terminal: `conda create -n SINet python=3.6`.
    
    + Installing necessary packages: `pip install -r requirements.txt`.
    
    - Installing [THOP](https://github.com/Lyken17/pytorch-OpCounter) for counting the FLOPs/Params of model.

#### 2.1. Overview

<p align="center">
    <img src="http://dpfan.net/wp-content/uploads/Inf-Net.png"/> <br />
    <em> 
    Figure 2. The architecture of our proposed Inf-Net model, which consists of three reverse attention 
    (RA) modules connected to the paralleled partial decoder (PPD).
    </em>
</p>

#### 2.2. Usage

1. Train

    - We provide multiple backbone versions (see this [line](https://github.com/DengPingFan/Inf-Net/blob/0df52ec8bb75ef468e9ceb7c43a41b0886eced3a/MyTrain_LungInf.py#L133)) in the training phase, i.e., ResNet, Res2Net, and VGGNet, but we only provide the Res2Net version in the Semi-Inf-Net. Also, you can try other backbones you prefer to, but the pseudo labels should be RE-GENERATED with corresponding backbone.
    
    - Turn off the semi-supervised mode (`--is_semi=False`) turn off the flag of whether use pseudo labels (`--is_pseudo=False`) in the parser of `MyTrain_LungInf.py` and just run it! (see this [line](https://github.com/DengPingFan/Inf-Net/blob/0df52ec8bb75ef468e9ceb7c43a41b0886eced3a/MyTrain_LungInf.py#L121))

2. Test
    
    - When training is completed, the weights will be saved in `./Snapshots/save_weights/Inf-Net/`. 
    You can also directly download the pre-trained weights from [Google Drive](https://drive.google.com/open?id=19p_G8NS4NwF4pZOEOX3w06ZLVh0rj3VW).
    
    - Assign the path `--pth_path` of trained weights and `--save_path` of results save and in `MyTest_LungInf.py`.
    
    - Just run it and results will be saved in `./Results/Lung infection segmentation/Inf-Net`

### 2.3. Training Set

1. Lung infection which consists of 50 labels by doctors (Doctor-label) and 1600 pseudo labels generated (Pseudo-label) 
by our Semi-Inf-Net model. [Download Link](http://dpfan.net/wp-content/uploads/LungInfection-Train.zip).

2. Multi-Class lung infection which also composed of 50 multi-class labels (GT) by doctors and 50 lung infection 
labels (Prior) generated by our Semi-Inf-Net model. [Download Link](http://dpfan.net/wp-content/uploads/MultiClassInfection-Train.zip).

### 2.4. Test Set

1. The Lung infection segmentation set contains 48 images associate with 48 GT. [Download Link](http://dpfan.net/wp-content/uploads/LungInfection-Test.zip).

2. The Multi-Class lung infection segmentation set has 48 images and 48 GT. [Download Link](http://dpfan.net/wp-content/uploads/MultiClassInfection-Test.zip).

## 3. Results

To compare the infection regions segmentation performance, we consider the two state-of-the-art models U-Net and U-Net++. 
We also show the multi-class infection labelling results in Fig. 5. As can be observed, 
our model, Semi-Inf-Net & FCN8s, consistently performs the best among all methods. It is worth noting that both GGO and 
consolidation infections are accurately segmented by Semi-Inf-Net & FCN8s, which further demonstrates the advantage of 
our model. In contrast, the baseline methods, DeepLabV3+ with different strides and FCNs, all obtain unsatisfactory 
results, where neither GGO and consolidation infections can be accurately segmented.

Overall results can be downloaded from this [link](http://dpfan.net/wp-content/uploads/COVID-SemiSeg-Results.zip).

Lung infection segmentation results can be downloaded from this [link](http://dpfan.net/wp-content/uploads/Lung-infection-segmentation.zip)

Multi-class lung infection segmentation can be downloaded from this [link](http://dpfan.net/wp-content/uploads/Multi-class-lung-infection-segmentation.zip)

## 4. Visualization Results:

<p align="center">
    <img src="http://dpfan.net/wp-content/uploads/InfectionSeg.png"/> <br />
    <em> 
    Figure 4. Visual comparison of lung infection segmentation results.
    </em>
</p>

<p align="center">
    <img src="http://dpfan.net/wp-content/uploads/MultiClassInfectionSeg.png"/> <br />
    <em> 
    Figure 5. Visual comparison of multi-class lung infection segmentation results, where the red and green labels 
    indicate the GGO and consolidation, respectively.
    </em>
</p>

## 5. Citation

	@article{fan2020inf,
  	title={Inf-Net: Automatic COVID-19 Lung Infection Segmentation from CT Images},
  	author={Fan, Deng-Ping and Zhou, Tao and Ji, Ge-Peng and Zhou, Yi and Chen, Geng and Fu, Huazhu and Shen, Jianbing and Shao, Ling},
  	journal={IEEE TMI},
  	year={2020}
	}
